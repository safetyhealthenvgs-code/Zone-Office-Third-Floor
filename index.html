<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แผนผังถังดับเพลิง</title>

<style>
body{font-family:sans-serif;padding:20px}
h2{text-align:center}
.filter{text-align:center;margin-bottom:10px}

.map-container{
  position:relative;
  width:100%;
  max-width:867px;
  aspect-ratio:867 / 595;
  background-image:url('https://github.com/safetyhealthenvgs-code/Zone-Office-Third-Floor/blob/main/Lay%20out%20office%20third%20floor.jpg?raw=true');
  background-size:contain;
  background-position:top left;
  background-repeat:no-repeat;
  border:1px solid #ccc;
  margin:auto
}

.marker{
  position:absolute;
  width:12px;height:12px;
  background:red;
  border:2px solid white;
  border-radius:50%;
  transform:translate(-50%,-50%);
  cursor:pointer
}

.marker:hover::after{
  content:attr(data-info);
  position:absolute;
  top:-65px;left:50%;
  transform:translateX(-50%);
  background:#000c;color:#fff;
  padding:6px 8px;
  border-radius:4px;
  font-size:12px;
  white-space:pre;
  z-index:10
}
</style>
</head>

<body>

<h2>แผนผังถังดับเพลิง</h2>

<div class="filter">
  เลือกเดือน:
  <select id="monthFilter"></select>
</div>

<div class="map-container" id="map"></div>

<script>
const SHEET_ID="18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME="Zone Office Third Floor";

const DATE_COL=1, INSPECTOR_COL=2, NUMBER_COL=3, XY_COL=13;

const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
let rows=[];

/* ===== PARSE DATE (หัวใจของการแก้ NaN/3111) ===== */
function parseThaiDate(v){
  if (!v) return null;

  // กรณีเป็น string เช่น 27/9/2568
  if (typeof v === "string" && v.includes("/")) {
    const [d,m,y]=v.split("/").map(Number);
    return { day:d, month:m, yearBE:y, yearCE:y-543 };
  }

  // fallback (กรณีเป็น Date object จริง)
  const d=new Date(v);
  if (isNaN(d)) return null;
  return {
    day:d.getDate(),
    month:d.getMonth()+1,
    yearBE:d.getFullYear()+543,
    yearCE:d.getFullYear()
  };
}

/* ===== LOAD DATA ===== */
fetch(url)
.then(r=>r.text())
.then(t=>{
  const json=JSON.parse(t.substring(47).slice(0,-2));
  rows=json.table.rows;
  buildDropdown();
});

/* ===== BUILD DROPDOWN ===== */
function buildDropdown(){
  const set=new Set();

  rows.forEach(r=>{
    const d=parseThaiDate(r.c[DATE_COL]?.v);
    if(!d) return;
    set.add(`${d.month}/${d.yearCE}`);
  });

  const sel=document.getElementById("monthFilter");
  sel.innerHTML="";

  [...set].sort((a,b)=>{
    const [ma,ya]=a.split("/").map(Number);
    const [mb,yb]=b.split("/").map(Number);
    return yb-ya||mb-ma;
  }).forEach(v=>{
    const [m,y]=v.split("/").map(Number);
    const o=document.createElement("option");
    o.value=v;
    o.textContent=`${m}/${y+543}`;
    sel.appendChild(o);
  });

  sel.onchange=()=>renderMap(sel.value);
  if(sel.value) renderMap(sel.value);
}

/* ===== RENDER MAP ===== */
function renderMap(selected){
  const map=document.getElementById("map");
  map.innerHTML="";

  rows.forEach(r=>{
    const d=parseThaiDate(r.c[DATE_COL]?.v);
    if(!d || `${d.month}/${d.yearCE}`!==selected) return;

    const xy=r.c[XY_COL]?.v;
    if(!xy||!xy.includes(",")) return;
    const [x,y]=xy.split(",").map(Number);

    const info=
`วันที่ตรวจ: ${d.day}/${d.month}/${d.yearBE}
หมายเลขถัง: ${r.c[NUMBER_COL]?.v||""}
ผู้ตรวจ: ${r.c[INSPECTOR_COL]?.v||""}`;

    const m=document.createElement("div");
    m.className="marker";
    m.style.left=`${x}%`;
    m.style.top=`${y}%`;
    m.setAttribute("data-info",info);

    map.appendChild(m);
  });
}
</script>

</body>
</html>



