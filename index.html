<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แผนผังถังดับเพลิง</title>

<style>
body{font-family:sans-serif;padding:20px}
h2{text-align:center}
.filter{text-align:center;margin-bottom:10px}
.map-container{
  position:relative;
  width:100%;
  max-width:867px;
  aspect-ratio:867/595;
  background:url('https://github.com/safetyhealthenvgs-code/Zone-Office-Third-Floor/blob/main/Lay%20out%20office%20third%20floor.jpg?raw=true')
    no-repeat top left;
  background-size:contain;
  border:1px solid #ccc;
  margin:auto
}
.marker{
  position:absolute;
  width:12px;height:12px;
  background:red;
  border:2px solid #fff;
  border-radius:50%;
  transform:translate(-50%,-50%);
  cursor:pointer
}
.marker:hover::after{
  content:attr(data-info);
  position:absolute;
  top:-65px;left:50%;
  transform:translateX(-50%);
  background:#000c;color:#fff;
  padding:6px 8px;
  font-size:12px;
  border-radius:4px;
  white-space:pre;
  z-index:10
}
</style>
</head>

<body>

<h2>แผนผังถังดับเพลิง</h2>

<div class="filter">
  เลือกเดือน:
  <select id="monthFilter"></select>
</div>

<div class="map-container" id="map"></div>

<script>
const SHEET_ID="18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME="Zone Office Third Floor";

const DATE_COL=1, INSPECTOR_COL=2, NUMBER_COL=3, XY_COL=13;
const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
let rows=[];

/* ===== แสดงปีแบบปลอดภัย ===== */
function displayYear(y){
  y=parseInt(y,10);
  return y<2400 ? y+543 : y;
}

/* ===== parseDate แบบไม่แตะปี ===== */
function parseDate(cell){
  if(!cell) return null;

  if(typeof cell.v==="string"){
    const m=cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
    if(m){
      return {day:+m[3],month:+m[2]+1,year:+m[1]};
    }
  }

  if(typeof cell.f==="string"){
    const p=cell.f.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(p){
      return {day:+p[1],month:+p[2],year:+p[3]};
    }
  }
  return null;
}

/* ===== LOAD ===== */
fetch(url)
.then(r=>r.text())
.then(t=>{
  const json=JSON.parse(t.substring(47).slice(0,-2));
  rows=json.table.rows;
  buildDropdown();
});

/* ===== DROPDOWN ===== */
function buildDropdown(){
  const set=new Set();
  rows.forEach(r=>{
    const d=parseDate(r.c[DATE_COL]);
    if(d) set.add(`${d.month}/${d.year}`);
  });

  const sel=document.getElementById("monthFilter");
  sel.innerHTML="";

  [...set].sort((a,b)=>{
    const [ma,ya]=a.split("/").map(Number);
    const [mb,yb]=b.split("/").map(Number);
    return yb-ya||mb-ma;
  }).forEach(v=>{
    const [m,y]=v.split("/").map(Number);
    const o=document.createElement("option");
    o.value=v;
    o.textContent=`${m}/${displayYear(y)}`;
    sel.appendChild(o);
  });

  sel.onchange=()=>render(sel.value);
  render(sel.value);
}

/* ===== RENDER ===== */
function render(selected){
  const map=document.getElementById("map");
  map.innerHTML="";
  rows.forEach(r=>{
    const d=parseDate(r.c[DATE_COL]);
    if(!d||`${d.month}/${d.year}`!==selected) return;

    const xy=r.c[XY_COL]?.v;
    if(!xy||!xy.includes(",")) return;
    const [x,y]=xy.split(",").map(Number);

    const m=document.createElement("div");
    m.className="marker";
    m.style.left=`${x}%`;
    m.style.top=`${y}%`;
    m.setAttribute("data-info",
`วันที่ตรวจ: ${d.day}/${d.month}/${displayYear(d.year)}
หมายเลขถัง: ${r.c[NUMBER_COL]?.v||""}
ผู้ตรวจ: ${r.c[INSPECTOR_COL]?.v||""}`);
    map.appendChild(m);
  });
}
</script>

</body>
</html>


